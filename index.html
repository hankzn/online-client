<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<title>安全转账 · 在线端（验证 / 预演 / 广播 / 查询 / Gas 估算）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--fg:#111827;--muted:#6b7280;--ok:#16a34a;--bad:#dc2626;--br:#e5e7eb;--bg:#fff}
  *{box-sizing:border-box}
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg);max-width:1080px;margin:24px auto;padding:0 14px}
  h1{font-size:24px;margin:6px 0 18px}
  h2{font-size:18px;margin:0 0 12px}
  .card{border:1px solid var(--br);border-radius:12px;padding:16px;margin-bottom:20px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .col2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block}
  input,textarea,button{font-size:14px}
  input[type=text],textarea{width:100%;padding:10px;border:1px solid var(--br);border-radius:10px;font-family:monospace}
  textarea{min-height:120px}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--fg);background:var(--fg);color:#fff;cursor:pointer}
  button.ghost{background:#fff;color:var(--fg)}
  .muted{color:var(--muted)}
  .mono{font-family:monospace}
  .ok{color:var(--ok);font-weight:700}
  .bad{color:var(--bad);font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--br);text-align:left;vertical-align:top}
  video{width:100%;max-height:260px;background:#000;border-radius:10px}
  canvas{display:none}
  .pill{display:inline-block;padding:2px 8px;border-radius:9999px;background:#eef2ff;color:#4338ca;font-size:12px}
  .section-title{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .small{font-size:12px}
  .num{white-space:nowrap}
</style>
</head>
<body>
<h1>安全转账 · 在线端（验证 / 预演 / 广播 / 查询 / Gas 估算）</h1>

<div class="card">
  <div class="section-title">
    <h2>全局设置</h2>
    <span class="muted small">本页不会接触私钥；请填写你的 RPC 节点</span>
  </div>
  <div class="col2">
    <label>RPC_URL_1 <input id="rpc1" type="text" placeholder="https://mainnet.infura.io/v3/..." /></label>
    <label>RPC_URL_2 <input id="rpc2" type="text" placeholder="https://eth-mainnet.g.alchemy.com/v2/..." /></label>
  </div>
</div>

<!-- ① 验证收款确认单（EIP-712 Payment Intent） -->
<div class="card">
  <div class="section-title"><h2>① 验证 Payment Intent（EIP-712）</h2>
    <span class="pill">手机二维码可扫码填充</span>
  </div>
  <div class="col2">
    <label>intent.json
      <textarea id="intent_json" placeholder='{"payee":"0x...","token":"0x...","amount":"1000000","chainId":1,"deadline":1700000000,"nonce":"0x...","memo":"..."}'></textarea>
    </label>
    <label>intent.sig
      <input id="intent_sig" type="text" placeholder="0x 签名 hex" />
    </label>
  </div>
  <div class="row">
    <button id="scan_intent_json" class="ghost">扫码 intent.json</button>
    <button id="scan_intent_sig" class="ghost">扫码 intent.sig</button>
    <button id="verify_intent">验证 Intent</button>
    <span id="intent_status" class="muted"></span>
  </div>

  <div id="intent_result" class="muted mono" style="margin-top:10px"></div>

  <!-- 摄像头容器（复用，按需显示） -->
  <div id="cam_box" class="card" style="display:none;margin-top:12px">
    <div class="row"><button id="stop_scan" class="ghost">停止扫码</button><span id="scan_status" class="muted"></span></div>
    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>
</div>

<!-- ② 广播 RawTx -->
<div class="card">
  <div class="section-title"><h2>② 广播已签名 RawTx（双 RPC）</h2>
    <span class="pill">支持二维码扫码</span>
  </div>
  <label>RawTx
    <textarea id="rawtx" placeholder="0x..."></textarea>
  </label>
  <div class="row">
    <button id="scan_rawtx" class="ghost">扫码 RawTx</button>
    <button id="broadcast">广播</button>
    <span id="broadcast_status" class="muted"></span>
  </div>
  <div id="broadcast_table_box" style="margin-top:12px"></div>
</div>

<!-- ③ 预演（eth_call） -->
<div class="card">
  <div class="section-title"><h2>③ 签名前预演（eth_call）</h2>
    <span class="muted small">粘贴或扫码离线端生成的 tx_human.json</span>
  </div>
  <label>tx_human.json
    <textarea id="tx_human" placeholder='{"kind":"ERC20","from":"0x...","token":"0x...","to":"0x...","amount_smallest_unit":1000000,"data_hex":"0xa9059cbb...","value_wei":0,"chainId":1,"nonce":12,"gas":60000}'></textarea>
  </label>
  <div class="row">
    <button id="scan_tx_human" class="ghost">扫码 tx_human.json</button>
    <button id="simulate">在两条 RPC 上预演</button>
    <span id="simulate_status" class="muted"></span>
  </div>
  <div id="simulate_table_box" style="margin-top:12px"></div>
</div>

<!-- ④ 查询交易状态 -->
<div class="card">
  <div class="section-title"><h2>④ 查询交易状态（双 RPC）</h2></div>
  <div class="row">
    <input id="txhash" type="text" placeholder="0x 交易哈希" style="flex:1" />
    <button id="query">查询</button>
    <span id="query_status" class="muted"></span>
  </div>
  <div id="query_table_box" style="margin-top:12px"></div>
</div>

<!-- ⑤ MetaMask 风格的 Gas 估算（低/中/高） -->
<div class="card">
  <div class="section-title">
    <h2>⑤ Gas 估算（低 / 中 / 高）</h2>
    <span class="muted small">基于 tx_human.json 的真实 to/data/value 进行 estimateGas；feeHistory 计算 EIP-1559 费用档位</span>
  </div>
  <div class="row">
    <label class="small">
      gasLimit 缓冲（%）
      <input id="gas_buffer_pct" type="number" value="20" style="width:90px" />
    </label>
    <button id="estimate_gas">估算（双 RPC）</button>
    <span id="estimate_status" class="muted"></span>
  </div>
  <div id="estimate_table_box" style="margin-top:12px"></div>
  <p class="muted small">提示：Gas 与“代币数量”通常无关；复杂合约路径除外。本估算以你提供的 tx_human.json 为准。</p>
</div>

<!-- 依赖：ethers v6 + jsQR（在线端用 CDN 更方便） -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const log = (el, msg)=> el.textContent = msg;

  // 统一 JSON-RPC 调用
  async function rpcCall(url, method, params) {
    const r = await fetch(url, {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify({jsonrpc:"2.0", id: Date.now(), method, params})
    });
    const j = await r.json();
    if (j.error) throw new Error(j.error.message || JSON.stringify(j.error));
    return j.result;
  }
  function requireRPCs() {
    const u1 = $("rpc1").value.trim();
    const u2 = $("rpc2").value.trim();
    if (!u1 || !u2) throw new Error("请先填写 RPC_URL_1 与 RPC_URL_2");
    return [u1, u2];
  }
  const toHex = (n)=> "0x"+BigInt(n).toString(16);

  // ========== 摄像头扫码（复用一套） ==========
  // 支持的目标：intent_json | intent_sig | rawtx | tx_human
  let scanTarget = null;
  let stream = null, rafId = null;

  async function startScan(target) {
    scanTarget = target;
    $("cam_box").style.display = "";
    log($("scan_status"), "启动摄像头…");
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      $("video").srcObject = stream;
      await $("video").play();
      log($("scan_status"), "请将二维码对准取景框");
      tick();
    }catch(e){
      log($("scan_status"), "无法打开摄像头：" + e.message);
    }
  }
  function stopScan() {
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
    $("video").srcObject = null;
    $("cam_box").style.display = "none";
    scanTarget = null;
  }
  function tick(){
    const v = $("video");
    if (!v.videoWidth){ rafId = requestAnimationFrame(tick); return; }
    const c = $("canvas"), ctx = c.getContext("2d");
    c.width = v.videoWidth; c.height = v.videoHeight;
    ctx.drawImage(v, 0, 0, c.width, c.height);
    const img = ctx.getImageData(0, 0, c.width, c.height);
    const code = jsQR(img.data, c.width, c.height, { inversionAttempts:"attemptBoth" });
    if (code && code.data){
      const txt = code.data.trim();
      if (scanTarget === "rawtx") {
        if (/^0x[0-9a-fA-F]+$/.test(txt) && txt.length > 100) {
          $("rawtx").value = txt; stopScan();
          log($("broadcast_status"), "已填入 RawTx（来自二维码）");
          return;
        }
      } else if (scanTarget === "intent_sig") {
        if (/^0x[0-9a-fA-F]+$/.test(txt) && txt.length > 100) {
          $("intent_sig").value = txt; stopScan();
          log($("intent_status"), "已填入 intent.sig（来自二维码）");
          return;
        }
      } else if (scanTarget === "intent_json") {
        try {
          JSON.parse(txt);
          $("intent_json").value = txt; stopScan();
          log($("intent_status"), "已填入 intent.json（来自二维码）");
          return;
        } catch {}
      } else if (scanTarget === "tx_human") {
        try {
          JSON.parse(txt);
          $("tx_human").value = txt; stopScan();
          log($("simulate_status"), "已填入 tx_human.json（来自二维码）");
          return;
        } catch {}
      }
    }
    rafId = requestAnimationFrame(tick);
  }
  $("stop_scan").onclick = stopScan;
  $("scan_intent_json").onclick = ()=> startScan("intent_json");
  $("scan_intent_sig").onclick  = ()=> startScan("intent_sig");
  $("scan_rawtx").onclick       = ()=> startScan("rawtx");
  $("scan_tx_human").onclick    = ()=> startScan("tx_human");

  // ========== ① 验证 Intent ==========
  $("verify_intent").onclick = async ()=>{
    const out = $("intent_result");
    try{
      const intent = JSON.parse($("intent_json").value || "{}");
      const sig = ($("intent_sig").value || "").trim();
      if (!sig) throw new Error("缺少签名（intent.sig）");
      const domain = { name:"PaymentIntent", version:"1", chainId:Number(intent.chainId||0), verifyingContract:"0x0000000000000000000000000000000000000000" };
      const types = { PaymentIntent:[
        {name:"payee",type:"address"},
        {name:"token",type:"address"},
        {name:"amount",type:"uint256"},
        {name:"chainId",type:"uint256"},
        {name:"deadline",type:"uint64"},
        {name:"nonce",type:"bytes32"},
        {name:"memo",type:"string"},
      ]};
      const recovered = ethers.verifyTypedData(domain, types, intent, sig);
      const ok = (recovered.toLowerCase() === String(intent.payee||"").toLowerCase());
      log($("intent_status"), ok ? "验签通过" : "验签失败");
      out.innerHTML =
        `恢复地址：<span class="mono">${recovered}</span><br>`+
        `<span class="${ok?'ok':'bad'}">${ok?'签名人与 payee 一致':'签名人与 payee 不一致'}</span><br><br>`+
        `<b>Intent 内容：</b><br><pre>${escapeHtml(JSON.stringify(intent,null,2))}</pre>`;
    }catch(e){
      log($("intent_status"), "错误：" + e.message);
      out.textContent = "";
    }
  };

  // ========== ② 广播 RawTx ==========
  $("broadcast").onclick = async ()=>{
    const box = $("broadcast_table_box");
    try{
      const [u1,u2] = requireRPCs();
      const raw = ($("rawtx").value||"").trim();
      if (!/^0x[0-9a-fA-F]+$/.test(raw) || raw.length<=100) throw new Error("RawTx 格式不正确");
      const txhash = ethers.keccak256(raw);
      log($("broadcast_status"), "计算本地 txhash: " + txhash);
      const urls = [u1,u2], names = ["RPC_1","RPC_2"];
      const results = await Promise.allSettled(urls.map(u => rpcCall(u,"eth_sendRawTransaction",[raw])));
      const rows = results.map((r,i)=>{
        if (r.status==="fulfilled") {
          return `<tr><td>${names[i]}</td><td class="mono">${escapeHtml(urls[i])}</td><td class="ok">OK</td><td class="mono">${escapeHtml(r.value)}</td></tr>`;
        } else {
          return `<tr><td>${names[i]}</td><td class="mono">${escapeHtml(urls[i])}</td><td class="bad">FAIL</td><td class="mono">${escapeHtml(r.reason.message||String(r.reason))}</td></tr>`;
        }
      }).join("");
      box.innerHTML = `
        <div class="muted" style="margin:6px 0">本地计算 txhash：<span class="mono">${txhash}</span></div>
        <table><tr><th>RPC</th><th>URL</th><th>结果</th><th>响应/错误</th></tr>${rows}</table>`;
      $("txhash").value = txhash;
    }catch(e){
      log($("broadcast_status"), "错误：" + e.message);
      box.innerHTML = "";
    }
  };

  // ========== ③ 预演（eth_call） ==========
  $("simulate").onclick = async ()=>{
    const box = $("simulate_table_box");
    try{
      const [u1,u2] = requireRPCs();
      const h = JSON.parse($("tx_human").value||"{}");
      const call = {
        from: h.from,
        to: h.kind==="ETH" ? h.to : h.token,
        data: h.data_hex || "0x",
        value: "0x" + BigInt(h.value_wei||0).toString(16)
      };
      const urls=[u1,u2], names=["RPC_1","RPC_2"];
      const results = await Promise.allSettled(urls.map(u => rpcCall(u,"eth_call",[call,"latest"])));
      const rows = results.map((r,i)=>{
        if (r.status==="fulfilled") {
          let val = r.value;
          if (typeof val === "string" && val.startsWith("0x") && val.length===2) val = "(0x)";
          return `<tr><td>${names[i]}</td><td class="ok">OK</td><td class="mono">${escapeHtml(String(val))}</td></tr>`;
        } else {
          return `<tr><td>${names[i]}</td><td class="bad">FAIL</td><td class="mono">${escapeHtml(r.reason.message||String(r.reason))}</td></tr>`;
        }
      }).join("");
      box.innerHTML = `<table><tr><th>RPC</th><th>结果</th><th>返回/错误</th></tr>${rows}</table>`;
      log($("simulate_status"), "预演完成");
    }catch(e){
      log($("simulate_status"), "错误：" + e.message);
      box.innerHTML = "";
    }
  };

  // ========== ④ 查询状态 ==========
  $("query").onclick = async ()=>{
    const box = $("query_table_box");
    try{
      const [u1,u2] = requireRPCs();
      const th = ($("txhash").value||"").trim();
      if (!/^0x[0-9a-fA-F]{64}$/.test(th)) throw new Error("txhash 格式不正确");
      const urls=[u1,u2], names=["RPC_1","RPC_2"];
      const results = await Promise.allSettled(urls.map(async (u)=>{
        const r = await rpcCall(u,"eth_getTransactionReceipt",[th]);
        if (!r) return { ok:true, block:null, status:null, raw:r };
        return {
          ok: true,
          block: r.blockNumber ? parseInt(r.blockNumber, 16) : null,
          status: r.status ? parseInt(r.status,16) : null,
          raw: r
        };
      }));
      const rows = results.map((r,i)=>{
        if (r.status==="fulfilled"){
          const v=r.value;
          return `<tr><td>${names[i]}</td><td class="${v.ok?'ok':'bad'}">${v.ok}</td><td class="mono">${v.block??''}</td><td class="mono">${v.status??''}</td></tr>`;
        }else{
          return `<tr><td>${names[i]}</td><td class="bad">false</td><td class="mono"></td><td class="mono">${escapeHtml(r.reason.message||String(r.reason))}</td></tr>`;
        }
      }).join("");
      box.innerHTML = `<table><tr><th>RPC</th><th>ok</th><th>block</th><th>status</th></tr>${rows}</table>`;
      log($("query_status"), "查询完成");
    }catch(e){
      log($("query_status"), "错误：" + e.message);
      box.innerHTML = "";
    }
  };

  // ========== ⑤ Gas 估算（低/中/高） ==========
  $("estimate_gas").onclick = async ()=>{
    const box = $("estimate_table_box");
    try{
      const [u1,u2] = requireRPCs();
      const h = JSON.parse($("tx_human").value||"{}");
      // 构造 estimateGas 调用体
      const tx = {
        from: h.from,
        to: h.kind==="ETH" ? h.to : h.token,
        data: h.data_hex || "0x",
        value: "0x" + BigInt(h.value_wei||0).toString(16)
      };
      const bufferPct = Math.max(0, Number($("gas_buffer_pct").value || 0));
      const urls=[u1,u2], names=["RPC_1","RPC_2"];

      // 对每条 RPC 并行：estimateGas + feeHistory
      const results = await Promise.allSettled(urls.map(async (u)=>{
        const gasHex = await rpcCall(u,"eth_estimateGas",[tx]);
        const gas = parseInt(gasHex, 16);
        const gasBuffered = Math.ceil(gas * (1 + bufferPct/100));

        // feeHistory：取近 10 个区块，分位点 10 / 50 / 90
        const fh = await rpcCall(u,"eth_feeHistory",[10, "latest", [10,50,90]]);
        // baseFeePerGas：数组 hex，取最后一个（最新区块的 baseFee）
        const baseFees = (fh.baseFeePerGas||[]).map(x=> BigInt(x));
        const baseFeeLatest = baseFees[baseFees.length-1] ?? 0n;
        // priority rewards：二维数组 [block][percentileIndex]，取每个分位的中位数（防毛刺）
        const rewards = (fh.reward||[]).map(row=> row.map(x=> BigInt(x)));
        const pickMedian = (arr)=> arr.slice().sort((a,b)=> (a<b?-1:1))[Math.floor(arr.length/2)] || 0n;
        const col = (idx)=> rewards.map(r=> r[idx]).filter(Boolean);
        const p10 = pickMedian(col(0));
        const p50 = pickMedian(col(1));
        const p90 = pickMedian(col(2));

        // 档位系数（可按需调整）
        const tier = (name, priority, baseMul)=> {
          const maxPriorityFeePerGas = priority; // wei
          const maxFeePerGas = baseFeeLatest * BigInt(Math.round(baseMul*100)) / 100n + maxPriorityFeePerGas;
          const feeTotalWei = BigInt(gasBuffered) * maxFeePerGas;
          return { name, gas, gasBuffered, baseFeeLatest, maxPriorityFeePerGas, maxFeePerGas, feeTotalWei };
        };
        // 低/中/高（baseFee 乘数 1.2 / 1.5 / 2.0）
        return {
          url: u,
          tiers: [
            tier("低速", p10, 1.2),
            tier("中速", p50, 1.5),
            tier("高速", p90, 2.0),
          ]
        };
      }));

      // 渲染
      const fmtGwei = (wei)=> (Number(wei) / 1e9).toFixed(3) + " gwei";
      const fmtEth  = (wei)=> (Number(wei) / 1e18).toFixed(6) + " ETH";

      const tables = results.map((r,i)=>{
        if (r.status!=="fulfilled") {
          return `<div class="muted"><b>${names[i]}</b>：<span class="bad">FAIL</span> ${escapeHtml(r.reason.message||String(r.reason))}</div>`;
        }
        const {url, tiers} = r.value;
        const rows = tiers.map(t=>{
          return `<tr>
            <td>${t.name}</td>
            <td class="num mono">${t.gas}</td>
            <td class="num mono">${t.gasBuffered}</td>
            <td class="num mono">${fmtGwei(t.baseFeeLatest)}</td>
            <td class="num mono">${fmtGwei(t.maxPriorityFeePerGas)}</td>
            <td class="num mono">${fmtGwei(t.maxFeePerGas)}</td>
            <td class="num mono">${fmtEth(t.feeTotalWei)}</td>
          </tr>`;
        }).join("");
        return `
          <div class="muted small" style="margin:6px 0"><b>${names[i]}</b> · ${escapeHtml(url)}</div>
          <table>
            <tr>
              <th>档位</th>
              <th>估算 gasLimit</th>
              <th>gasLimit（含缓冲）</th>
              <th>baseFee</th>
              <th>maxPriorityFee</th>
              <th>maxFeePerGas</th>
              <th>预计总费用</th>
            </tr>
            ${rows}
          </table>
        `;
      }).join("");

      $("estimate_table_box").innerHTML = tables;
      log($("estimate_status"), "估算完成");
    }catch(e){
      log($("estimate_status"), "错误：" + e.message);
      $("estimate_table_box").innerHTML = "";
    }
  };

  // HTML 转义
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
})();
</script>
</body>
</html>
